#include "init_destory.h"
/*-----------------------------------*/
/**
 *
 */
/*-----------------------------------*/
void init()
{
	init_image_cfg();

	signal(SIGINT,StopRun);

	FPGA_CTRL_mmap();

	get_queue_img_buff();

	dmac_addr_mmap();

	initSemSignal();

	init_mem_pool();

}

/*-----------------------------------*/
/**
 *
 */
/*-----------------------------------*/
void destory()
{
	sleep(3);

	FPGA_CTRL_unmmap();

	remove_queue_img_buff();

	dmac_addr_unmap();

	destorySemSignal();

	destory_mem_pool();
}
/*-----------------------------------*/
/**
 *
 */
/*-----------------------------------*/
void run_main()
{
	do{

			sleep(1);

			sendImageHeartbeat();

	}while(IsRun());
}
/*-----------------------------------*/
/**
 *
 */
/*-----------------------------------*/
int main_out_ring()
{
	test();

		init();

			pthread_t thread_task_tcp_flow=task_flow_ctrl_server();
			pthread_t thread_task_fpga_cvt=init_fpga_cvt_server(NULL);
			pthread_t thread_task_dma=init_dma_server(NULL);
			pthread_t thread_task_memcpy=init_memcpy_server(NULL);

		#if 0
			pthread_t thread_task_tcp_trans_row=tcp_trans_row_data(NULL);
		#else
			pthread_t thread_task_tcp_trans_row=tcp_trans_row_data_2(NULL);
		#endif

			//pthread_t thread_task_mem_rcv=rcv_image_buff_axi_server(NULL);
			pthread_t thread_task_tcp_rcv=tcp_image_buff_axi_server(NULL);

			//pthread_t thread_task_tcp_telnet=tcp_telnet(NULL);

		run_main();


		destory();

		pthread_join(thread_task_tcp_flow,NULL);
		pthread_join(thread_task_tcp_trans_row,NULL);
		pthread_join(thread_task_tcp_rcv,NULL);

		pthread_join(thread_task_fpga_cvt,NULL);
		pthread_join(thread_task_dma,NULL);
		pthread_join(thread_task_memcpy,NULL);

		return EXIT_SUCCESS;
}
/*-----------------------------------*/
/**
 *
 */
/*-----------------------------------*/
